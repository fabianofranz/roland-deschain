<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Servlet 3 Async Test</title>
  <meta name="description" content="Servlet 3 Async Test">
  <meta name="author" content="Fabiano Franz">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="css/style.css">
  <script src="js/libs/modernizr-2.0.6.min.js"></script>
</head>

<body>

  <div id="map_canvas" style="width:100%; height:100%"></div>
                    
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true"></script>
  <script type="text/javascript" src="js/jquery.stream-1.2.min.js"></script>
  <script type="text/javascript" defer src="js/plugins.js"></script>
  <script type="text/javascript">
      
                markers = new Array();
	
		$(document).ready(function() {
                    
                    var position = new google.maps.LatLng(35.657872, 139.70232);
                    var map = new google.maps.Map(
                        document.getElementById("map_canvas"), 
                        { zoom: 14, center: position, mapTypeId: google.maps.MapTypeId.ROADMAP });

	           $.stream("./async", {
	                   type: "http",
	                   dataType: "json",
	                   context: $("#map-canvas")[0],
	                   open: function(event, stream) {
                                stream.send({});
	                   },
	                   message: function(event) {
                                $.each(event.data, function(index1, update) { 
                                    if (update.object == "geography") {
                                        $.getJSON("./details?object=" + update.object_id, function(instagrams) {
                                            $.each(instagrams.data, function(index2, instagram) { 
                                                var p = new google.maps.LatLng(instagram.location.latitude, instagram.location.longitude);
                                                var marker = new google.maps.Marker({ position: p, title: instagram.user.username });
                                                if ($.inArray(marker, markers) == -1) {
                                                    marker.setMap(map);
                                                    var info = new google.maps.InfoWindow({
                                                        content: "<img src='" + instagram.images.thumbnail + "' />"
                                                    });
                                                    google.maps.event.addListener(marker, 'click', function() {
                                                        info.open(map, marker);
                                                    });
                                                    markers.push(marker);
                                                } else {
                                                    marker = null;
                                                }

                                           });
                                        });
                                    }
                                });
	                   },
	                   error: function() {
                                alert("error");
	                   },
	                   close: function() {
	                   }
	           });
	                   
		});
		
  </script>

	
  <!--[if lt IE 7 ]>
    <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
    <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->
  
</body>
</html>
